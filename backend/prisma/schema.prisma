// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: TENANTS Y BUSINESS UNITS
// ============================================

model Tenant {
  id     String       @id @default(uuid())
  name   String
  slug   String       @unique
  status TenantStatus @default(ACTIVE)

  // SaaS Billing (subscription to the platform)
  plan         String  @default("free") // free, pro, enterprise
  billingEmail String?

  // Payment Provider Selection
  country                  String? // ISO 3166-1 alpha-2 (CO, MX, US, etc.)
  preferredPaymentProvider String? // stripe, wompi, mercadopago

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits BusinessUnit[]
  users         User[]
  subscriptions PlatformSubscription[]
  auditLogs     AuditLog[]

  @@index([slug])
  @@index([country])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

model BusinessUnit {
  id          String  @id @default(uuid())
  tenantId    String
  name        String
  description String?
  slug        String

  // Configuración
  settings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enabledModules    BusinessUnitModule[]
  workflows         Workflow[]
  userBusinessUnits UserBusinessUnit[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("business_units")
}

// ============================================
// CORE: USUARIOS Y AUTENTICACIÓN
// ============================================

model User {
  id        String     @id @default(uuid())
  tenantId  String
  email     String
  password  String
  firstName String
  lastName  String
  avatar    String?
  status    UserStatus @default(ACTIVE)

  // Password Reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Sistema
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnits UserBusinessUnit[]
  auditLogs     AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([resetPasswordToken])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Relación many-to-many con roles por BU
model UserBusinessUnit {
  id             String @id @default(uuid())
  userId         String
  businessUnitId String
  roleId         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, businessUnitId])
  @@index([userId])
  @@index([businessUnitId])
  @@map("user_business_units")
}

// ============================================
// CORE: RBAC - ROLES Y PERMISOS
// ============================================

model Role {
  id          String  @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean @default(false) // true = no se puede eliminar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  permissions       RolePermission[]
  userBusinessUnits UserBusinessUnit[]

  @@map("roles")
}

model Permission {
  id       String          @id @default(uuid())
  resource String // "projects", "users", "settings"
  action   String // "create", "read", "update", "delete"
  scope    PermissionScope @default(BUSINESS_UNIT)

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

enum PermissionScope {
  TENANT // Acceso a nivel tenant
  BUSINESS_UNIT // Acceso a nivel business unit (default)
  OWN // Solo datos propios
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// CORE: MÓDULOS Y ACTIVACIÓN
// ============================================

model Module {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?
  version     String  @default("1.0.0")
  category    String? // "commerce", "projects", "livestock", "logistics"

  isActive Boolean @default(true)

  // Configuración por defecto
  defaultConfig Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits BusinessUnitModule[]
  workflows     Workflow[]

  @@map("modules")
}

model BusinessUnitModule {
  id             String @id @default(uuid())
  businessUnitId String
  moduleId       String

  isEnabled Boolean @default(true)
  config    Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId])
  @@index([businessUnitId])
  @@map("business_unit_modules")
}

// ============================================
// CORE: WORKFLOWS CONFIGURABLES
// ============================================

model Workflow {
  id             String  @id @default(uuid())
  businessUnitId String
  moduleId       String
  name           String
  description    String?

  // Estados del workflow (JSON array)
  states Json // [{ id, name, color, order, isInitial, isFinal }]

  // Transiciones permitidas (JSON array)
  transitions Json // [{ from, to, label, requiredRole }]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId, name])
  @@map("workflows")
}

// ============================================
// CORE: BILLING DEL SAAS (SUSCRIPCIONES)
// ============================================

model PlatformSubscription {
  id       String             @id @default(uuid())
  tenantId String
  plan     String // free, pro, enterprise
  status   SubscriptionStatus @default(ACTIVE)

  // Facturación
  amount       Float
  currency     String @default("USD")
  billingCycle String @default("monthly") // monthly, yearly

  // Fechas
  startDate       DateTime
  endDate         DateTime?
  nextBillingDate DateTime?
  cancelledAt     DateTime?

  // Proveedor de pago
  paymentProvider String? // stripe, mercadopago, etc
  externalId      String? // ID en el proveedor externo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("platform_subscriptions")
}

enum SubscriptionStatus {
  PENDING // Esperando confirmación de pago
  ACTIVE // Suscripción activa
  PAST_DUE // Pago vencido
  CANCELLED // Cancelada por el usuario
  EXPIRED // Expirada por falta de pago
}

// ============================================
// CORE: AUDITORÍA Y TRAZABILIDAD
// ============================================

model AuditLog {
  id       String  @id @default(uuid())
  tenantId String
  userId   String?

  entity   String // "user", "project", "invoice"
  entityId String?
  action   String // "create", "update", "delete"

  // Datos antes y después (opcional)
  oldData Json?
  newData Json?

  metadata  Json    @default("{}")
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
