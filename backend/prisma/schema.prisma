// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: TENANTS Y BUSINESS UNITS
// ============================================

model Tenant {
  id     String       @id @default(uuid())
  name   String
  slug   String       @unique
  status TenantStatus @default(ACTIVE)

  // SaaS Billing (subscription to the platform)
  plan         String  @default("free") // free, pro, enterprise
  billingEmail String?

  // Payment Provider Selection
  country                  String? // ISO 3166-1 alpha-2 (CO, MX, US, etc.)
  preferredPaymentProvider String? // stripe, wompi, mercadopago

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits     BusinessUnit[]
  users             User[]
  subscriptions     PlatformSubscription[]
  auditLogs         AuditLog[]
  eventQueue        EventQueue[]
  assets            Asset[]
  supplies          Supply[]
  rentalContracts   RentalContract[]
  suppliers         Supplier[]
  supplyQuotes      SupplyQuote[]
  purchaseOrders    PurchaseOrder[]
  stockTransactions StockTransaction[]
  supplyCategories  SupplyCategory[]
  clients           Client[]
  clientMovements   ClientAccountMovement[]
  clientConfigs     ClientRankingConfig[]
  clientBUs         ClientBusinessUnit[]
  clientAccounts    ClientAccount[] // Cuentas de alquiler
  templates         Template[]
  quotations        Quotation[]
  stockLevels       StockLevel[]
  stockMovements    StockMovement[]
  bulkRentalItems   BulkRentalItem[]
  documentTemplates DocumentTemplate[]
  emailTemplates    EmailTemplate[]

  @@index([slug])
  @@index([country])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

model BusinessUnit {
  id          String  @id @default(uuid())
  tenantId    String
  name        String
  description String?
  slug        String

  // Configuración
  settings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                 Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enabledModules         BusinessUnitModule[]
  workflows              Workflow[]
  userBusinessUnits      UserBusinessUnit[]
  userPermissions        UserPermission[] // Permisos adicionales de usuarios en esta BU
  integrationCredentials IntegrationCredential[]
  integrations           BusinessUnitIntegration[]
  channelConfigs         BusinessUnitChannelConfig[]
  businessUnitIntents    BusinessUnitIntent[]
  userChannelIdentities  UserChannelIdentity[]
  eventQueue             EventQueue[]
  assetTemplates         AssetTemplate[]
  assets                 Asset[]
  stockLevels            StockLevel[]
  supplyCategories       SupplyCategory[]
  supplies               Supply[]
  rentalContracts        RentalContract[]
  suppliers              Supplier[]
  supplyQuotes           SupplyQuote[]
  purchaseOrders         PurchaseOrder[]
  stockTransactions      StockTransaction[]
  clientMovements        ClientAccountMovement[]
  clientConfigs          ClientRankingConfig[]
  templates              Template[]
  quotations             Quotation[]
  quotationContracts     QuotationContract[]
  clientBUs              ClientBusinessUnit[]
  assetDocumentTypes     AssetDocumentType[]
  branding               BusinessUnitBranding?
  documentTemplates      DocumentTemplate[]
  emailTemplates         EmailTemplate[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("business_units")
}

// ============================================
// CORE: USUARIOS Y AUTENTICACIÓN
// ============================================

model User {
  id        String     @id @default(uuid())
  tenantId  String? // Nullable para SUPER_ADMIN
  email     String
  password  String
  firstName String
  lastName  String
  avatar    String?
  status    UserStatus @default(ACTIVE)
  role      UserRole   @default(USER) // Nuevo campo global

  // Password Reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Sistema
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tenant             Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnits      UserBusinessUnit[]
  userPermissions    UserPermission[] // Permisos adicionales específicos del usuario
  auditLogs          AuditLog[]
  channelIdentities  UserChannelIdentity[]
  eventQueue         EventQueue[]
  assetUsages        AssetUsage[]
  assignedQuotations Quotation[]           @relation("AssignedQuotations")
  createdQuotations  Quotation[]           @relation("CreatedQuotations")

  // Rental relations
  createdRentals         AssetRental[]           @relation
  createdRentalContracts RentalContract[]        @relation("RentalContractCreator")
  createdRentalMovements RentalAccountMovement[] @relation("RentalMovementCreator")

  // Stock management relations
  createdStockMovements  StockMovement[]  @relation("StockMovementCreator")
  createdBulkRentalItems BulkRentalItem[] @relation("BulkRentalItemCreator")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([resetPasswordToken])
  @@index([role])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN // Cross-tenant access, system configuration, unlimited privileges
  DEVELOPER // System inspection, logs, metrics, debugging (read-only, no data modification)
  USER // Normal user with role-based permissions per Business Unit
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Relación many-to-many con roles por BU
model UserBusinessUnit {
  id             String @id @default(uuid())
  userId         String
  businessUnitId String
  roleId         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, businessUnitId])
  @@index([userId])
  @@index([businessUnitId])
  @@map("user_business_units")
}

// ============================================
// CORE: RBAC - ROLES Y PERMISOS
// ============================================

model Role {
  id          String  @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean @default(false) // true = no se puede eliminar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  permissions       RolePermission[]
  userBusinessUnits UserBusinessUnit[]

  @@map("roles")
}

model Permission {
  id       String          @id @default(uuid())
  resource String // "projects", "users", "settings"
  action   String // "create", "read", "update", "delete"
  scope    PermissionScope @default(BUSINESS_UNIT)

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  roles           RolePermission[]
  userPermissions UserPermission[] // Permisos asignados directamente a usuarios

  @@unique([resource, action])
  @@map("permissions")
}

enum PermissionScope {
  TENANT // Acceso a nivel tenant
  BUSINESS_UNIT // Acceso a nivel business unit (default)
  OWN // Solo datos propios
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Permisos adicionales asignados directamente a usuarios
// Se SUMAN a los permisos del rol
model UserPermission {
  id             String @id @default(uuid())
  userId         String
  businessUnitId String // Los permisos adicionales son por BU
  permissionId   String

  createdAt DateTime @default(now())
  createdBy String? // Usuario que otorgó el permiso

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  permission   Permission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, businessUnitId, permissionId])
  @@index([userId, businessUnitId])
  @@map("user_permissions")
}

// ============================================
// CORE: MÓDULOS Y ACTIVACIÓN
// ============================================

model Module {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?
  version     String  @default("1.0.0")
  category    String? // "commerce", "projects", "livestock", "logistics"

  isActive Boolean @default(true)

  // Configuración por defecto
  defaultConfig Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits BusinessUnitModule[]
  workflows     Workflow[]

  @@map("modules")
}

model BusinessUnitModule {
  id             String @id @default(uuid())
  businessUnitId String
  moduleId       String

  isEnabled Boolean @default(true)
  config    Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId])
  @@index([businessUnitId])
  @@map("business_unit_modules")
}

// ============================================
// CORE: WORKFLOWS CONFIGURABLES
// ============================================

model Workflow {
  id             String  @id @default(uuid())
  businessUnitId String
  moduleId       String
  name           String
  description    String?

  // Estados del workflow (JSON array)
  states Json // [{ id, name, color, order, isInitial, isFinal }]

  // Transiciones permitidas (JSON array)
  transitions Json // [{ from, to, label, requiredRole }]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId, name])
  @@map("workflows")
}

// ============================================
// CORE: BILLING DEL SAAS (SUSCRIPCIONES)
// ============================================

model PlatformSubscription {
  id       String             @id @default(uuid())
  tenantId String
  plan     String // free, pro, enterprise
  status   SubscriptionStatus @default(ACTIVE)

  // Facturación
  amount       Float
  currency     String @default("USD")
  billingCycle String @default("monthly") // monthly, yearly

  // Fechas
  startDate       DateTime
  endDate         DateTime?
  nextBillingDate DateTime?
  cancelledAt     DateTime?

  // Proveedor de pago
  paymentProvider String? // stripe, mercadopago, etc
  externalId      String? // ID en el proveedor externo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("platform_subscriptions")
}

enum SubscriptionStatus {
  PENDING // Esperando confirmación de pago
  ACTIVE // Suscripción activa
  PAST_DUE // Pago vencido
  CANCELLED // Cancelada por el usuario
  EXPIRED // Expirada por falta de pago
}

// ============================================
// CORE: AUDITORÍA Y TRAZABILIDAD
// ============================================

model AuditLog {
  id       String  @id @default(uuid())
  tenantId String
  userId   String?

  entity   String // "user", "project", "invoice"
  entityId String?
  action   String // "create", "update", "delete"

  // Datos antes y después (opcional)
  oldData Json?
  newData Json?

  metadata  Json    @default("{}")
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// CORE: INTEGRACIONES EXTERNAS
// ============================================

// Credenciales de integraciones por BusinessUnit
// Cada BU puede tener sus propias configuraciones de proveedores externos
model IntegrationCredential {
  id             String          @id @default(uuid())
  businessUnitId String
  provider       IntegrationType

  // Credenciales encriptadas (JSON flexible según proveedor)
  credentials Json

  // Estado
  isActive      Boolean   @default(true)
  lastValidated DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, provider])
  @@index([businessUnitId])
  @@map("integration_credentials")
}

// Configuración de integraciones de terceros (facturación, envíos, etc.)
model BusinessUnitIntegration {
  id             String @id @default(uuid())
  businessUnitId String
  type           String // "invoice", "shipping", "sms", "email"
  provider       String // "taxxa", "divanco", "fedex", "manual", etc.

  // Credenciales y configuración
  credentials Json // { apiKey, apiSecret, accountNumber, etc. }
  config      Json // { environment, defaultOrigin, metadata, etc. }

  // Estado
  isActive      Boolean   @default(true)
  lastValidated DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, type, provider])
  @@index([businessUnitId])
  @@index([type])
  @@map("business_unit_integrations")
}

enum IntegrationType {
  // Comunicaciones
  SENDGRID // Email transaccional y marketing
  AZURE_COMMUNICATION_SERVICES // Email + SMS + WhatsApp de Azure
  META_WHATSAPP // WhatsApp Business Cloud API
  TWILIO_SMS // SMS transaccional

  // Pagos
  STRIPE // Pagos internacionales
  MERCADOPAGO // Pagos LATAM
  WOMPI // Pagos Colombia

  // Storage
  AZURE_BLOB_STORAGE // Azure Blob Storage con Sharp
  AWS_S3 // Almacenamiento de archivos (legacy)
  CLOUDINARY // Imágenes y multimedia (legacy)

  // Facturación
  SIIGO // Facturación electrónica Colombia
  FACTURAMA // Facturación electrónica México

  // Firma Digital
  DIGITAL_SIGNATURE // SignNow, DocuSign, HelloSign

  // Otros
  GOOGLE_MAPS // Mapas y geolocalización
  SENDGRID_ANALYTICS // Analytics de emails
}

// ============================================
// CANALES E INTENCIONES
// ============================================

// Configuración de canales por Business Unit
model BusinessUnitChannelConfig {
  id             String      @id @default(uuid())
  businessUnitId String
  channel        ChannelType

  // Estado
  enabled Boolean @default(true)

  // Intenciones permitidas desde este canal
  // ["*"] = todas, o lista específica como ["UPLOAD_IMAGE", "PROJECT_UPDATE"]
  allowedIntents Json @default("[]")

  // Configuración específica del canal (opcional)
  config Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, channel])
  @@index([businessUnitId])
  @@map("business_unit_channel_configs")
}

enum ChannelType {
  WHATSAPP
  WEB
  MOBILE
  API
}

// Catálogo de intenciones disponibles en la plataforma
model IntentDefinition {
  id          String  @id @default(uuid())
  name        String  @unique // "UPLOAD_IMAGE", "PROJECT_UPDATE", etc.
  displayName String // "Subir Imagen", "Actualizar Proyecto"
  description String?
  category    String? // "storage", "projects", "communications"

  // Módulo y acción por defecto
  defaultModule String // "storage", "projects"
  defaultAction String // "uploadFile", "updateStatus"

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnitIntents BusinessUnitIntent[]

  @@map("intent_definitions")
}

// Configuración de intenciones por Business Unit
// Permite personalizar qué hace cada intención en cada BU
model BusinessUnitIntent {
  id             String @id @default(uuid())
  businessUnitId String
  intentId       String

  // Personalización de la acción (sobrescribe defaults)
  module             String? // Si null, usa defaultModule
  action             String? // Si null, usa defaultAction
  requiredPermission String? // "projects.update", "files.upload"

  // Configuración específica de la intención
  config Json @default("{}")

  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit     BusinessUnit     @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  intentDefinition IntentDefinition @relation(fields: [intentId], references: [id])

  @@unique([businessUnitId, intentId])
  @@index([businessUnitId])
  @@map("business_unit_intents")
}

// Identidad de usuario en canales externos (WhatsApp, etc.)
model UserChannelIdentity {
  id             String      @id @default(uuid())
  userId         String
  businessUnitId String
  channel        ChannelType

  // Identificador en el canal externo
  externalId String // Número de teléfono para WhatsApp, deviceId para mobile, etc.

  // Verificación
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  // Metadata adicional
  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([userId, businessUnitId, channel, externalId])
  @@index([userId])
  @@index([externalId, channel])
  @@map("user_channel_identities")
}

// Cola de eventos para procesamiento asíncrono y offline
model EventQueue {
  id             String      @id @default(uuid())
  tenantId       String
  businessUnitId String
  userId         String
  channel        ChannelType

  // Intención y datos
  intent  String
  payload Json

  // Estado del procesamiento
  status EventStatus @default(PENDING)

  // Metadata
  metadata Json @default("{}")

  // Reintentos
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?
  processedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([tenantId])
  @@index([userId])
  @@map("event_queue")
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// ASSETS MODULE - Rental Equipment Management
// ============================================

model AssetTemplate {
  id             String @id @default(uuid())
  businessUnitId String

  name        String // "Retroexcavadora", "Andamio Tubular"
  category    AssetCategory // MACHINERY | IMPLEMENT | VEHICLE | TOOL
  description String?
  icon        String? // Emoji o nombre de ícono

  // Management type: individual tracking vs bulk inventory
  managementType AssetManagementType @default(UNIT)

  requiresPreventiveMaintenance Boolean @default(false)
  requiresDocumentation         Boolean @default(false) // Si requiere SOAT, Seguro, Certificaciones, etc.

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Archivos y documentación
  // ═══════════════════════════════════════
  attachments Json? // { manuals: [{name, url, type}], images: [{url, description, isPrimary}], certifications: [...], msds: {...} }

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Presentación del producto
  // ═══════════════════════════════════════
  presentation Json? // { unit: "litros", containerSize: 20, containerType: "Caneca" }

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Especificaciones técnicas
  // ═══════════════════════════════════════
  technicalSpecs Json? // Flexible: { power: "75HP", fuelType: "Diesel" } o { viscosity: "SAE 15W-40", apiGrade: "CI-4" }

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Compatibilidad con equipos
  // ═══════════════════════════════════════
  compatibleWith Json? // { equipmentCategories: ["MACHINERY"], equipmentIds: ["uuid1", "uuid2"] }

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Reglas de negocio para cotizaciones
  // ═══════════════════════════════════════
  businessRules Json? // { requiresTransport: true, requiresOperator: true, requiresInsurance: true, autoSuggestSupplies: ["uuid1"] }

  // ═══════════════════════════════════════
  // RENTAL VERTICAL: Control de insumos
  // ═══════════════════════════════════════
  hasExpiryDate       Boolean @default(false) // Si el producto tiene fecha de vencimiento
  requiresLotTracking Boolean @default(false) // Si requiere control de lotes/batch
  isDangerous         Boolean @default(false) // Si es un producto peligroso
  hazardClass         String? // Clasificación: "FLAMMABLE", "CORROSIVE", "TOXIC", etc.

  // Array de definiciones de campos personalizados (opcional)
  customFields Json? // CustomField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit       BusinessUnit        @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  assets             Asset[]
  purchaseOrderItems PurchaseOrderItem[]
  stockLevels        StockLevel[] // For BULK management type
  bulkRentalItems    BulkRentalItem[] // BULK items in rental contracts

  @@unique([businessUnitId, name])
  @@index([businessUnitId])
  @@index([category])
  @@index([managementType])
  @@map("asset_templates")
}

enum AssetCategory {
  // ═══ EQUIPOS ═══
  MACHINERY // Maquinaria pesada (requiere mantenimiento preventivo típicamente)
  IMPLEMENT // Implementos (andamios, herramientas grandes)
  VEHICLE // Vehículos
  TOOL // Herramientas menores

  // ═══ INSUMOS (RENTAL VERTICAL) ═══
  SUPPLY_FUEL // Combustibles (diesel, gasolina, gas)
  SUPPLY_OIL // Aceites y lubricantes (motor, hidráulico, transmisión)
  SUPPLY_PAINT // Pinturas, solventes, adhesivos
  SUPPLY_SPARE_PART // Repuestos y partes (filtros, mangueras, sellos)
  SUPPLY_CONSUMABLE // Consumibles generales (trapos, guantes, EPP desechable)
  SUPPLY_SAFETY // Equipos de seguridad reutilizables (cascos, arneses, gafas)
}

enum AssetManagementType {
  UNIT // Individual tracking (one DB row per physical unit)
  BULK // Quantity-based inventory (stock levels only)
}

model Asset {
  id             String  @id @default(uuid())
  tenantId       String
  businessUnitId String
  templateId     String? // Relación opcional con template

  code            String // Código interno único (RET-001, AND-045)
  name            String
  assetType       String // String libre: machine, implement, vehicle, etc (deprecated, usar template.category)
  acquisitionCost Decimal?
  origin          String?

  // ============================================
  // ORIGEN DE COMPRA (Integración con Purchase Orders)
  // ============================================
  purchaseOrderId String? // Orden de compra de origen (si fue comprado)
  supplierId      String? // Proveedor del activo
  purchaseDate    DateTime? // Fecha de compra
  purchasePrice   Decimal? // Precio de compra (puede diferir de acquisitionCost por impuestos/envío)

  currentLocation String? // Ubicación actual del activo (obra, taller, bodega)

  // Imagen principal (foto de portada del activo)
  imageUrl String? // URL en Azure Blob Storage

  // ═══════════════════════════════════════
  // RENTAL: Tipo de tracking
  // ═══════════════════════════════════════
  trackingType String? // "MACHINERY" | "TOOL" | null (legacy assets)

  // ═══════════════════════════════════════
  // RENTAL: Precios
  // ═══════════════════════════════════════

  // Para MACHINERY:
  pricePerHour  Decimal? @db.Decimal(10, 2) // $625/hora
  minDailyHours Decimal? @db.Decimal(5, 2) // STANDBY: Mínimo horas/día (ej: 3.0)
  pricePerKm    Decimal? @db.Decimal(10, 2) // $5/km (opcional)

  // Para TOOL:
  pricePerDay   Decimal? @db.Decimal(10, 2) // $200/día
  pricePerWeek  Decimal? @db.Decimal(10, 2) // $1,200/sem (opcional)
  pricePerMonth Decimal? @db.Decimal(10, 2) // $4,500/mes (opcional)

  // Costo del operario (si aplica)
  operatorCostType String? // "PER_DAY" | "PER_HOUR" | null (sin operario)
  operatorCostRate Decimal? @db.Decimal(10, 2) // $3,000/día OR $375/hora

  maintenanceCostDaily Decimal? @db.Decimal(10, 2)

  // Datos dinámicos según template
  customData Json? // Almacena los valores de los customFields del template

  requiresOperator Boolean @default(false)
  requiresTracking Boolean @default(false)
  requiresClinic   Boolean @default(false) // Requiere historia clínica de mantenimiento

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit       BusinessUnit        @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  template           AssetTemplate?      @relation(fields: [templateId], references: [id], onDelete: SetNull)
  purchaseOrder      PurchaseOrder?      @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  supplier           Supplier?           @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  state              AssetState?
  maintenanceRecords MaintenanceRecord[]
  usages             AssetUsage[]
  events             AssetEvent[]
  attachments        AssetAttachment[]
  supplyUsages       SupplyUsage[]
  contractAssets     ContractAsset[]
  usageReports       UsageReport[]
  incidents          Incident[]
  preventiveConfigs  PreventiveConfig[]
  maintenanceEvents  MaintenanceEvent[]
  stockTransactions  StockTransaction[]
  quotationItems     QuotationItem[]
  generatedFromItems PurchaseOrderItem[] @relation("GeneratedAsset")
  purchaseOrderItems PurchaseOrderItem[]
  assetRentals       AssetRental[] // Assets en alquiler activo

  @@unique([businessUnitId, code])
  @@index([tenantId, businessUnitId])
  @@index([assetType])
  @@index([templateId])
  @@index([purchaseOrderId])
  @@index([supplierId])
  @@index([trackingType])
  @@map("assets")
}

model AssetState {
  id           String @id @default(uuid())
  assetId      String @unique
  workflowId   String
  currentState String // String libre, workflow-driven

  updatedAt DateTime @updatedAt

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@map("asset_states")
}

model AssetEvent {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  assetId        String

  eventType String // String libre: created, rented, returned, maintenance_started, etc
  payload   Json
  source    String // String libre: web, mobile, whatsapp, system

  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id])

  @@index([tenantId, businessUnitId, assetId])
  @@index([assetId, createdAt])
  @@index([eventType])
  @@map("asset_events")
}

model MaintenanceRecord {
  id          String    @id @default(uuid())
  assetId     String
  description String?
  startedAt   DateTime
  endedAt     DateTime?

  asset             Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  stockTransactions StockTransaction[]

  @@index([assetId])
  @@index([startedAt])
  @@map("maintenance_records")
}

model AssetUsage {
  id      String   @id @default(uuid())
  assetId String
  date    DateTime

  // NUEVO: Relación con AssetRental (si viene de reporte de operario)
  rentalId String?

  // Métricas (campos legados - mantener compatibilidad)
  hoursUsed    Decimal?
  standbyHours Decimal?

  // Métricas flexibles (nuevo sistema)
  metricType  String? // "HOURS", "KM", "CYCLES", "UNITS", "HOUROMETER", "ODOMETER", "BOTH"
  metricValue Decimal? // Valor de la métrica
  kmUsed      Decimal? // Específico para vehículos

  // ═══════════════════════════════════════
  // RENTAL: Reportes diarios del operario
  // ═══════════════════════════════════════

  // Horómetro
  hourometerStart Decimal? @db.Decimal(10, 2)
  hourometerEnd   Decimal? @db.Decimal(10, 2)
  hoursWorked     Decimal? @db.Decimal(5, 2) // Horas reales trabajadas
  hoursBilled     Decimal? @db.Decimal(5, 2) // Horas facturadas (con standby)

  // Odómetro
  odometerStart Decimal? @db.Decimal(10, 2)
  odometerEnd   Decimal? @db.Decimal(10, 2)
  kmTraveled    Decimal? @db.Decimal(5, 2)

  // Cálculo de costos (automático)
  machineryCost Decimal? @db.Decimal(10, 2) // Costo por uso de máquina
  operatorCost  Decimal? @db.Decimal(10, 2) // Viáticos del operario
  totalCost     Decimal? @db.Decimal(10, 2) // Total del día

  // Estado del reporte
  status      String    @default("pending") // "pending", "processed", "rejected"
  processedAt DateTime?

  // Evidencia fotográfica (horómetro, odómetro)
  evidenceUrls Json? // Array de URLs: ["url1", "url2"]

  reportedByUserId String?
  source           String // String libre: APP, WHATSAPP, API, SYSTEM
  notes            String?

  // Sincronización offline (para app móvil)
  createdAtDevice DateTime? // Timestamp cuando se creó en el dispositivo
  syncedAt        DateTime? // Timestamp cuando se sincronizó con servidor

  createdAt DateTime @default(now())

  asset      Asset                   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  rental     AssetRental?            @relation(fields: [rentalId], references: [id], onDelete: SetNull)
  reportedBy User?                   @relation(fields: [reportedByUserId], references: [id], onDelete: SetNull)
  movements  RentalAccountMovement[] @relation("UsageMovements")

  @@index([assetId, date])
  @@index([rentalId, date])
  @@index([reportedByUserId])
  @@index([status, processedAt])
  @@map("asset_usages")
}

// ============================================
// RENTAL: AssetRental - Assets en Alquiler
// ============================================

model AssetRental {
  id         String @id @default(uuid())
  contractId String
  assetId    String

  // Fechas
  withdrawalDate     DateTime  @default(now())
  expectedReturnDate DateTime?
  actualReturnDate   DateTime? // Null mientras esté en uso

  // Tracking específico
  trackingType String // "MACHINERY" | "TOOL"

  // Para MACHINERY:
  hourlyRate       Decimal? @db.Decimal(10, 2)
  operatorCostType String? // "PER_DAY" | "PER_HOUR"
  operatorCostRate Decimal? @db.Decimal(10, 2)

  // Tracking de uso (MACHINERY)
  initialHourometer Decimal? @db.Decimal(10, 2) // Horómetro inicial
  currentHourometer Decimal? @db.Decimal(10, 2) // Último reporte
  totalHoursUsed    Decimal  @default(0) @db.Decimal(10, 2)

  initialOdometer Decimal? @db.Decimal(10, 2) // Odómetro inicial
  currentOdometer Decimal? @db.Decimal(10, 2) // Último reporte
  totalKmUsed     Decimal  @default(0) @db.Decimal(10, 2)

  // Para TOOL:
  dailyRate   Decimal? @db.Decimal(10, 2)
  daysElapsed Int      @default(0) // Se actualiza automático

  // Montos acumulados
  totalMachineryCost Decimal @default(0) @db.Decimal(12, 2)
  totalOperatorCost  Decimal @default(0) @db.Decimal(12, 2)
  totalCost          Decimal @default(0) @db.Decimal(12, 2)

  // Último descuento realizado
  lastChargeDate DateTime?

  // Evidencias
  withdrawalEvidence String[] // URLs fotos al retirar
  returnEvidence     String[] // URLs fotos al devolver

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relaciones
  contract     RentalContract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
  asset        Asset                   @relation(fields: [assetId], references: [id])
  creator      User                    @relation(fields: [createdBy], references: [id])
  usageReports AssetUsage[]
  movements    RentalAccountMovement[] @relation("RentalMovements")

  @@index([contractId, actualReturnDate]) // Para buscar assets activos
  @@index([assetId, actualReturnDate])
  @@index([lastChargeDate]) // Para cron job de descuentos
  @@map("asset_rentals")
}

model AssetAttachment {
  id      String @id @default(uuid())
  assetId String

  // Genérico
  type     String // String libre: PHOTO, DOCUMENT, VIDEO, etc
  url      String
  fileName String?
  source   String // String libre: WHATSAPP, APP, SYSTEM

  // Para documentos con vencimiento (opcional)
  documentTypeId String? // Si es documento, referencia a AssetDocumentType
  issueDate      DateTime?
  expiryDate     DateTime? // Si null, no vence
  alertDays      Int? // Días antes para alertar (sobrescribe default del tipo)

  // Alertas y estado
  lastAlertSent DateTime?
  status        AttachmentStatus @default(ACTIVE)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset        Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  documentType AssetDocumentType? @relation(fields: [documentTypeId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([type])
  @@index([expiryDate])
  @@index([status])
  @@index([documentTypeId])
  @@map("asset_attachments")
}

enum AttachmentStatus {
  ACTIVE // Vigente
  EXPIRING // Por vencer (dentro del rango de alerta)
  EXPIRED // Vencido
  ARCHIVED // Archivado (reemplazado por nuevo documento)
}

// Tipos de documentos configurables por BusinessUnit
model AssetDocumentType {
  id             String @id @default(uuid())
  businessUnitId String

  code        String // Código único: "SOAT", "REVISION_TECNICA", "CERT_CALIBRACION"
  name        String // Nombre descriptivo: "SOAT - Seguro Obligatorio"
  description String?

  // Configuración de alertas por defecto
  defaultAlertDays Int? // Días antes del vencimiento para alertar (ej: 30)

  // UI
  color String? // Color hex para mostrar en frontend: "#FF5733"
  icon  String? // Nombre del ícono: "file-text", "shield", "certificate"

  // Validaciones
  requiresFile   Boolean @default(true) // Si debe tener archivo adjunto
  requiresExpiry Boolean @default(true) // Si debe tener fecha de vencimiento

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessUnit BusinessUnit      @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  attachments  AssetAttachment[]

  @@unique([businessUnitId, code])
  @@index([businessUnitId])
  @@index([isActive])
  @@map("asset_document_types")
}

// ============================================
// BULK INVENTORY: Stock Level Management
// ============================================
// For AssetTemplates with managementType = BULK
// Manages quantities without creating individual Asset rows

model StockLevel {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  templateId     String

  // Quantity tracking (NEVER update directly - use StockMovement service only)
  quantityAvailable Int @default(0) // Available for rental/sale
  quantityReserved  Int @default(0) // Reserved in quotations
  quantityRented    Int @default(0) // Currently rented out

  // Location (optional, for multi-location support)
  location String? // Warehouse, site, etc.

  // Pricing for bulk items (can override template defaults)
  pricePerDay   Decimal? @db.Decimal(10, 2)
  pricePerWeek  Decimal? @db.Decimal(10, 2)
  pricePerMonth Decimal? @db.Decimal(10, 2)
  unitCost      Decimal? @db.Decimal(10, 2) // Cost per unit for inventory valuation

  // Alerts
  minStock Int? // Minimum stock alert threshold
  maxStock Int? // Maximum stock capacity

  // Optimistic locking for concurrency control
  version Int @default(0)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit    BusinessUnit     @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  template        AssetTemplate    @relation(fields: [templateId], references: [id], onDelete: Restrict)
  movements       StockMovement[]
  bulkRentalItems BulkRentalItem[]

  @@unique([tenantId, businessUnitId, templateId, location])
  @@index([tenantId])
  @@index([businessUnitId])
  @@index([templateId])
  @@index([quantityAvailable])
  @@map("stock_levels")
}

// Stock movements for bulk inventory audit trail
model StockMovement {
  id           String @id @default(uuid())
  tenantId     String
  stockLevelId String

  // Movement type and quantity
  type     StockMovementType
  quantity Int // Always positive (type indicates direction)

  // Before/after snapshots for complete audit trail
  quantityBefore Int // Total quantity before this movement
  quantityAfter  Int // Total quantity after this movement

  // Detailed state snapshots
  availableBefore Int
  availableAfter  Int
  reservedBefore  Int
  reservedAfter   Int
  rentedBefore    Int
  rentedAfter     Int

  // References (REQUIRED for RESERVE, RENT_OUT, RETURN)
  referenceId   String? // Quotation ID, Contract ID, etc.
  referenceType String? // "Quotation", "RentalContract", "PurchaseOrder"

  // Reason is REQUIRED for ADJUST movements
  reason String? // "damaged", "lost", "initial", "purchase", etc.
  notes  String?

  // Location (if movement affects specific location)
  location String?

  // Audit
  createdAt DateTime @default(now())
  createdBy String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockLevel StockLevel @relation(fields: [stockLevelId], references: [id], onDelete: Cascade)
  creator    User?      @relation("StockMovementCreator", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([stockLevelId, createdAt])
  @@index([type])
  @@index([referenceId])
  @@index([referenceType])
  @@map("stock_movements")
}

enum StockMovementType {
  ADD // Incoming stock (purchase, transfer in, initial stock)
  RESERVE // Reserve stock for quotation
  UNRESERVE // Release reservation (quotation cancelled)
  RENT_OUT // Rent out to customer (contract signed)
  RETURN // Return from rental
  ADJUST // Manual adjustment (loss, damage, correction)
}

// ============================================
// BULK RENTAL ITEMS (Connect BULK inventory to contracts)
// ============================================

model BulkRentalItem {
  id         String @id @default(uuid())
  tenantId   String
  contractId String
  templateId String

  // Quantity and pricing snapshot at contract creation
  quantity      Int
  pricePerDay   Decimal? @db.Decimal(10, 2)
  pricePerWeek  Decimal? @db.Decimal(10, 2)
  pricePerMonth Decimal? @db.Decimal(10, 2)

  // Location tracking
  location String?

  // Reference to stock level used
  stockLevelId String?

  // Audit
  createdAt DateTime @default(now())
  createdBy String?

  // Relations
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract   RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  template   AssetTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  stockLevel StockLevel?    @relation(fields: [stockLevelId], references: [id], onDelete: SetNull)
  creator    User?          @relation("BulkRentalItemCreator", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([contractId])
  @@index([templateId])
  @@index([stockLevelId])
  @@map("bulk_rental_items")
}

// ============================================
// MÓDULO: CLIENTS (Clientes por BU)
// ============================================

model Client {
  id       String @id @default(uuid())
  tenantId String

  // Datos básicos (compartidos en todo el tenant)
  name        String // Razón social o nombre principal
  displayName String? // Alias o nombre corto
  type        ClientType @default(COMPANY)
  countryCode String? // ISO 3166-1 alpha-2 (CO, MX, US, ...)

  email String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tenant          Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts        ClientContact[]
  taxProfiles     ClientTaxProfile[]
  movements       ClientAccountMovement[]
  riskSnapshots   ClientRiskSnapshot[]
  businessUnits   ClientBusinessUnit[]
  quotations      Quotation[]
  rentalContracts RentalContract[]
  rentalAccount   ClientAccount? // Cuenta única para alquiler

  @@index([tenantId])
  @@index([name])
  @@map("clients")
}

// ============================================
// RENTAL: ClientAccount - Cuenta Única del Cliente
// ============================================

model ClientAccount {
  id       String @id @default(uuid())
  tenantId String
  clientId String @unique

  // Saldo compartido entre todos los contratos del cliente
  balance       Decimal @default(0) @db.Decimal(12, 2) // Saldo actual
  totalConsumed Decimal @default(0) @db.Decimal(12, 2) // Total consumido (todos los contratos)
  totalReloaded Decimal @default(0) @db.Decimal(12, 2) // Total recargado

  // Alertas (para usuarios internos)
  alertAmount    Decimal   @default(0) @db.Decimal(12, 2) // Monto en el cual alertar
  alertTriggered Boolean   @default(false)
  lastAlertSent  DateTime?

  // Estados de cuenta (para cliente)
  statementFrequency String? // "weekly" | "biweekly" | "monthly" | "manual"
  lastStatementSent  DateTime?
  nextStatementDue   DateTime?

  // Metadata
  notes    String? @db.Text
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tenant          Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  movements       RentalAccountMovement[] // Historial de movimientos
  rentalContracts RentalContract[]

  @@index([tenantId])
  @@index([balance]) // Para alertas de bajo saldo
  @@map("client_accounts")
}

enum ClientType {
  PERSON
  COMPANY
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

// Asignación de clientes a Business Units dentro de un tenant
model ClientBusinessUnit {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  clientId       String

  status ClientStatus @default(ACTIVE)

  // Segmentación flexible (ej: ["VIP", "Moroso"]), por BU
  tags Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([tenantId, businessUnitId, clientId])
  @@index([tenantId])
  @@index([businessUnitId])
  @@map("client_business_units")
}

model ClientContact {
  id       String          @id @default(uuid())
  clientId String
  name     String
  position String?
  email    String?
  phone    String?
  channel  ContactChannel? // Canal preferido

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_contacts")
}

enum ContactChannel {
  EMAIL
  PHONE
  WHATSAPP
}

model ClientTaxProfile {
  id       String @id @default(uuid())
  clientId String

  countryCode          String // CO, MX, etc.
  taxIdType            String // Configurable por país (NIT, CC, etc.)
  taxIdNumber          String
  taxRegime            String? // Régimen fiscal
  fiscalResponsibility String?

  fiscalAddressLine1 String?
  fiscalAddressLine2 String?
  city               String?
  state              String?
  postalCode         String?

  extra Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([countryCode])
  @@map("client_tax_profiles")
}

model ClientAccountMovement {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  clientId       String

  date      DateTime          @default(now())
  amount    Decimal           @db.Decimal(14, 2)
  direction MovementDirection
  currency  String            @default("USD")

  sourceModule String // "assets", "purchases", "sales", etc.
  sourceType   String // "QUOTE_DEPOSIT", "INVOICE", "CREDIT_NOTE", etc.
  sourceId     String?

  description  String?
  balanceAfter Decimal? @db.Decimal(14, 2)
  metadata     Json     @default("{}")

  createdAt DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([businessUnitId])
  @@index([clientId])
  @@index([date])
  @@map("client_account_movements")
}

enum MovementDirection {
  DEBIT
  CREDIT
}

// Configuración de ranking y políticas de riesgo por BusinessUnit
model ClientRankingConfig {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  // Ponderaciones para cálculo de score (JSON)
  weights Json @default("{}")

  // Umbrales por segmento y políticas (JSON)
  thresholds Json @default("{}")
  policies   Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId])
  @@index([tenantId])
  @@map("client_ranking_configs")
}

// Snapshot de riesgo para lecturas rápidas
model ClientRiskSnapshot {
  id       String @id @default(uuid())
  clientId String

  score   Int
  segment String // "TRUSTED", "NORMAL", "RISKY", etc.

  currentBalance Decimal? @db.Decimal(14, 2)
  details        Json     @default("{}")

  lastUpdatedAt DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId])
  @@index([segment])
  @@map("client_risk_snapshots")
}

// ============================================
// RENTAL MODULE: CONTRACTS & SUPPLIES
// ============================================

// Categorías configurables de insumos por BusinessUnit
model SupplyCategory {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  code        String // LUBRICANTE, FILTRO, REPUESTO, MATERIA_PRIMA, PRODUCT
  name        String // "Lubricantes", "Filtros", "Materia Prima"
  description String?

  // Tipo de categoría para comportamiento del sistema
  type SupplyCategoryType @default(CONSUMABLE)

  // Metadata para UI
  color String? // Hex color: "#3B82F6"
  icon  String? // Nombre del ícono: "droplet", "filter", "package"

  // Control de inventario por categoría
  requiresStockControl Boolean @default(true)
  allowNegativeStock   Boolean @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  supplies Supply[]

  @@unique([businessUnitId, code])
  @@index([tenantId, businessUnitId])
  @@index([type])
  @@map("supply_categories")
}

enum SupplyCategoryType {
  CONSUMABLE // Consumibles que se agotan (lubricantes, filtros)
  SPARE_PART // Repuestos y partes
  RAW_MATERIAL // Materia prima para producción
  FINISHED_PRODUCT // Productos terminados para venta
  TOOL // Herramientas menores no catalogadas como Asset
  OTHER // Otros tipos definidos por el usuario
}

model Supply {
  id             String  @id @default(uuid())
  tenantId       String
  businessUnitId String
  categoryId     String? // Relación con SupplyCategory

  code String? // Código interno del insumo (opcional)
  name String
  unit String // litros, unidades, kg, etc

  stock Decimal @default(0)

  // Gestión económica y alertas
  costPerUnit Decimal? // Costo promedio
  minStock    Decimal? // Stock mínimo para alertas
  maxStock    Decimal? // Stock máximo recomendado

  // Para productos terminados
  sku     String? // SKU para productos
  barcode String? // Código de barras

  // Metadata adicional
  notes String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit       BusinessUnit        @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  category           SupplyCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  usages             SupplyUsage[]
  quotes             SupplyQuote[]
  purchaseOrderItems PurchaseOrderItem[]
  transactions       StockTransaction[]

  @@unique([businessUnitId, code])
  @@index([tenantId, businessUnitId])
  @@index([categoryId])
  @@index([sku])
  @@map("supplies")
}

model SupplyUsage {
  id       String  @id @default(uuid())
  supplyId String
  assetId  String?
  quantity Decimal
  reason   String // preventive, post_obra, discard
  notes    String?

  createdAt DateTime @default(now())

  supply Supply @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  asset  Asset? @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([supplyId])
  @@index([assetId])
  @@index([reason])
  @@map("supply_usages")
}

// ============================================
// MÓDULO: PURCHASES & SUPPLIERS
// Gestión de proveedores, cotizaciones y órdenes de compra
// Reutilizable para cualquier BusinessUnit
// ============================================

model Supplier {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  // Datos comerciales
  code      String // Código interno (ej: PROV-001)
  name      String // Razón social
  tradeName String? // Nombre comercial
  taxId     String? // CUIT/RUT/RFC/NIT
  email     String?
  phone     String?
  website   String?

  // Dirección
  address String?
  city    String?
  state   String?
  country String?
  zipCode String?

  // Condiciones comerciales
  paymentTerms String? // "30 días", "Contado", etc.
  currency     String   @default("USD")
  creditLimit  Decimal?

  status SupplierStatus @default(ACTIVE)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  contacts       SupplierContact[]
  quotes         SupplyQuote[]
  purchaseOrders PurchaseOrder[]
  accountEntries SupplierAccountEntry[]
  assets         Asset[]

  @@unique([tenantId, businessUnitId, code])
  @@index([tenantId, businessUnitId])
  @@index([status])
  @@map("suppliers")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model SupplierContact {
  id         String @id @default(uuid())
  supplierId String

  name      String
  role      String? // "Gerente", "Vendedor", etc.
  email     String?
  phone     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@map("supplier_contacts")
}

model SupplierAccountEntry {
  id         String @id @default(uuid())
  supplierId String

  type    AccountEntryType
  amount  Decimal
  balance Decimal // Balance después de esta operación

  reference   String? // Nro de factura, recibo, etc.
  description String?
  dueDate     DateTime?

  purchaseOrderId String?

  createdAt DateTime @default(now())
  createdBy String?

  supplier      Supplier       @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  @@index([supplierId])
  @@index([type])
  @@index([createdAt])
  @@map("supplier_account_entries")
}

enum AccountEntryType {
  PURCHASE // Compra (aumenta deuda)
  PAYMENT // Pago (reduce deuda)
  CREDIT_NOTE // Nota de crédito (reduce deuda)
  DEBIT_NOTE // Nota de débito (aumenta deuda)
  ADJUSTMENT // Ajuste
}

model SupplyQuote {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  supplierId String
  supplyId   String // El insumo cotizado

  unitPrice Decimal
  quantity  Decimal?
  currency  String   @default("USD")

  validFrom  DateTime
  validUntil DateTime?

  notes    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  createdBy String?

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  supplier     Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supply       Supply       @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([supplyId])
  @@index([validFrom, validUntil])
  @@index([tenantId, businessUnitId])
  @@map("supply_quotes")
}

model PurchaseOrder {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  code       String // PO-001, PO-002
  supplierId String

  status PurchaseOrderStatus @default(DRAFT)

  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  subtotal Decimal @default(0)
  tax      Decimal @default(0)
  total    Decimal @default(0)
  currency String  @default("USD")

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  supplier     Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  items           PurchaseOrderItem[]
  accountEntries  SupplierAccountEntry[]
  transactions    StockTransaction[]
  generatedAssets Asset[]

  @@unique([tenantId, businessUnitId, code])
  @@index([tenantId, businessUnitId])
  @@index([supplierId])
  @@index([status])
  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  DRAFT // Borrador
  SENT // Enviada al proveedor
  CONFIRMED // Confirmada por proveedor
  RECEIVED // Mercadería recibida
  CANCELLED // Cancelada
}

model PurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  supplyId        String

  quantity   Decimal
  unitPrice  Decimal
  totalPrice Decimal

  receivedQty Decimal @default(0)

  // ============================================
  // INTEGRACIÓN CON MÓDULO DE MAQUINARIA
  // ============================================
  // Si este item es un activo (equipamiento), se puede crear automáticamente
  assetTemplateId  String? // Template del activo a crear (opcional)
  createsAsset     Boolean @default(false) // Si true, al recibir se crea el activo
  generatedAssetId String? // ID del activo creado (una vez recibido)

  notes String?

  purchaseOrder  PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  supply         Supply         @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  assetTemplate  AssetTemplate? @relation(fields: [assetTemplateId], references: [id], onDelete: SetNull)
  generatedAsset Asset?         @relation("GeneratedAsset", fields: [generatedAssetId], references: [id], onDelete: SetNull)
  asset          Asset?         @relation(fields: [assetId], references: [id])
  assetId        String?

  @@index([purchaseOrderId])
  @@index([supplyId])
  @@index([assetTemplateId])
  @@map("purchase_order_items")
}

model StockTransaction {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  supplyId String
  type     TransactionType

  quantity  Decimal // Positivo para entradas, negativo para salidas
  unitCost  Decimal?
  totalCost Decimal?

  // Relaciones opcionales según tipo
  purchaseOrderId     String?
  maintenanceRecordId String?
  assetId             String?

  reason String? // Para descartes: "Pintura volcada"
  notes  String?

  createdAt DateTime @default(now())
  createdBy String?

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit      BusinessUnit       @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  supply            Supply             @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  purchaseOrder     PurchaseOrder?     @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  maintenanceRecord MaintenanceRecord? @relation(fields: [maintenanceRecordId], references: [id], onDelete: SetNull)
  asset             Asset?             @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([tenantId, businessUnitId])
  @@index([supplyId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_transactions")
}

enum TransactionType {
  PURCHASE // Compra a proveedor
  MAINTENANCE_USE // Uso en mantenimiento
  DISCARD // Descarte (con motivo)
  ADJUSTMENT // Ajuste de inventario
  RETURN // Devolución a proveedor
}

model RentalContract {
  id              String  @id @default(uuid())
  tenantId        String
  businessUnitId  String
  quotationId     String? @unique
  clientId        String
  clientAccountId String // Cuenta única del cliente (compartida)
  code            String // CON-2026-001

  // Estado del contrato
  status String // "active", "suspended", "completed", "cancelled"

  // Fechas
  startDate        DateTime
  estimatedEndDate DateTime?
  actualEndDate    DateTime?

  // Tracking de consumo POR CONTRATO (solo informativo)
  totalConsumed Decimal @default(0) @db.Decimal(12, 2) // Total consumido por ESTE contrato

  // Último descuento realizado
  lastAutoChargeDate DateTime? // Última vez que se ejecutó descuento automático

  // Documentos
  templateId   String?
  pdfUrl       String?
  signedPdfUrl String?

  // Montos estimados
  estimatedTotal Decimal? @db.Decimal(12, 2)
  currency       String   @default("USD")

  // Metadata
  notes    String? @db.Text
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relaciones
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit  BusinessUnit  @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  quotation     Quotation?    @relation(fields: [quotationId], references: [id])
  client        Client        @relation(fields: [clientId], references: [id])
  clientAccount ClientAccount @relation(fields: [clientAccountId], references: [id])
  template      Template?     @relation(fields: [templateId], references: [id])
  creator       User?         @relation("RentalContractCreator", fields: [createdBy], references: [id])

  // Relaciones rental
  movements     RentalAccountMovement[] // Historial de transacciones (de ESTE contrato)
  activeRentals AssetRental[] // Assets actualmente rentados
  bulkItems     BulkRentalItem[] // BULK inventory items in this contract

  // Legacy relations (mantener compatibilidad)
  contractAssets ContractAsset[]
  usageReports   UsageReport[]
  incidents      Incident[]

  @@unique([tenantId, code])
  @@index([tenantId, businessUnitId])
  @@index([tenantId, businessUnitId, status])
  @@index([clientId])
  @@index([clientId, status])
  @@index([clientAccountId])
  @@index([status])
  @@index([lastAutoChargeDate]) // Para cron job
  @@map("rental_contracts")
}

// ============================================
// RENTAL: RentalAccountMovement - Historial de Transacciones
// ============================================

model RentalAccountMovement {
  id              String  @id @default(uuid())
  clientAccountId String // Cuenta del cliente (afecta balance compartido)
  contractId      String? // Contrato que generó el movimiento (null para recargas)

  // Tipo de movimiento
  movementType String // "INITIAL_CREDIT" | "CREDIT_RELOAD" | "DAILY_CHARGE" | "ADJUSTMENT" | "WITHDRAWAL_START" | "RETURN_END"

  // Montos
  amount        Decimal @db.Decimal(12, 2) // Monto (negativo para cargos)
  balanceBefore Decimal @db.Decimal(12, 2) // Saldo de ClientAccount ANTES
  balanceAfter  Decimal @db.Decimal(12, 2) // Saldo de ClientAccount DESPUÉS

  // Referencias
  assetRentalId String? // Si es cargo por asset específico
  usageReportId String? // Si viene de reporte del operario

  // Desglose de cargo diario
  machineryCost Decimal? @db.Decimal(10, 2) // Costo de máquina/herramienta
  operatorCost  Decimal? @db.Decimal(10, 2) // Viáticos del operario
  toolCost      Decimal? @db.Decimal(10, 2) // Costo herramientas

  // Descripción
  description  String   @db.Text
  evidenceUrls String[] // URLs fotos (si aplica)

  // Metadata
  notes    String? @db.Text
  metadata Json?

  createdAt DateTime @default(now())
  createdBy String?

  // Relaciones
  clientAccount ClientAccount   @relation(fields: [clientAccountId], references: [id], onDelete: Cascade)
  contract      RentalContract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  assetRental   AssetRental?    @relation(fields: [assetRentalId], references: [id], onDelete: SetNull, name: "RentalMovements")
  usage         AssetUsage?     @relation(fields: [usageReportId], references: [id], onDelete: SetNull, name: "UsageMovements")
  creator       User?           @relation("RentalMovementCreator", fields: [createdBy], references: [id])

  @@index([clientAccountId, createdAt]) // Estado de cuenta del cliente
  @@index([contractId, createdAt]) // Historial por contrato
  @@index([movementType])
  @@index([assetRentalId])
  @@map("rental_account_movements")
}

model ContractAsset {
  id         String @id @default(uuid())
  contractId String
  assetId    String
  obra       String // Nombre o identificador de la obra

  // Estimaciones
  estimatedStart DateTime
  estimatedEnd   DateTime
  estimatedHours Decimal?
  estimatedDays  Int?

  // Valores reales (al finalizar)
  actualEnd   DateTime?
  actualHours Decimal?

  // Evaluación post-obra
  needsPostObraMaintenance Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contract RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  asset    Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([assetId])
  @@index([obra])
  @@map("contract_assets")
}

model UsageReport {
  id         String  @id @default(uuid())
  assetId    String
  contractId String
  metric     String // horas, km, ciclos
  value      Decimal
  reportedBy String // operarioId (string libre, no relación dura)
  notes      String?

  // Evidencia
  evidenceUrls String[] // URLs a Azure Blob Storage

  createdAt DateTime @default(now())

  asset    Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  contract RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([contractId])
  @@index([createdAt])
  @@map("usage_reports")
}

model Incident {
  id          String  @id @default(uuid())
  assetId     String
  contractId  String
  description String
  resolved    Boolean @default(false)
  resolution  String? // Descripción de cómo se resolvió
  decision    String? // REPLACE, PAUSE, CONTINUE

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  asset    Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  contract RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([contractId])
  @@index([resolved])
  @@map("incidents")
}

model PreventiveConfig {
  id      String @id @default(uuid())
  assetId String
  version Int    @default(1)

  // Configuración de insumos (JSON flexible)
  suppliesConfig Json // { "supplyId": { "quantity": 5, "frequency": "cada 100 horas" } }
  notes          String?

  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, version])
  @@map("preventive_configs")
}

model MaintenanceEvent {
  id      String  @id @default(uuid())
  assetId String
  type    String // PREVENTIVE | POST_OBRA
  context String // OBRA | TALLER
  notes   String?

  // Relación con supplies usados
  suppliesUsed Json? // JSON con detalles de lo usado

  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([type])
  @@map("maintenance_events")
}

// ============================================
// SYSTEM: ANNOUNCEMENTS & MAINTENANCE
// ============================================

model SystemAnnouncement {
  id      String           @id @default(uuid())
  message String // Mensaje a mostrar
  type    AnnouncementType @default(INFO)
  active  Boolean          @default(true)

  // Scheduling
  startsAt DateTime?
  endsAt   DateTime?

  // Targeting (vacío = todos los tenants)
  affectedTenants String[] // Array de tenant IDs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, startsAt, endsAt])
  @@map("system_announcements")
}

enum AnnouncementType {
  INFO // Información general
  MAINTENANCE // Mantenimiento programado
  UPDATE // Nueva feature/actualización
  WARNING // Advertencia (deprecation, etc)
  CRITICAL // Problema crítico/downtime
}

// ============================================
// SHARED: TEMPLATES (Transversal)
// ============================================

model Template {
  id             String   @id @default(uuid())
  tenantId       String
  businessUnitId String
  name           String
  type           String // "quotation", "contract", "invoice", "receipt", "report", "certificate"
  content        String   @db.Text // HTML con variables Handlebars (solo body, sin header/footer)
  styles         String?  @db.Text // CSS personalizado adicional
  variables      Json // Array de TemplateVariable
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Nota: logoUrl, headerHtml, footerHtml fueron REMOVIDOS
  // Ahora se usan desde BusinessUnitBranding automáticamente

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  quotations         Quotation[]
  quotationContracts QuotationContract[]
  rentalContracts    RentalContract[]

  @@index([tenantId, businessUnitId, type])
  @@index([businessUnitId, isActive])
  @@map("templates")
}

// ============================================
// RENTAL MODULE: QUOTATIONS & CONTRACTS
// ============================================

model Quotation {
  id             String  @id @default(uuid())
  tenantId       String
  businessUnitId String
  code           String // QU-2026-001
  clientId       String
  assignedUserId String? // Vendedor/gestor

  status String // Workflow dinámico: "draft", "sent", "viewed", "signed", "paid", "cancelled"

  // Montos
  subtotal    Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  taxAmount   Decimal @db.Decimal(12, 2)
  totalAmount Decimal @db.Decimal(12, 2)
  currency    String  @default("USD")

  // ═══════════════════════════════════════
  // TIPO DE COTIZACIÓN (v4.0)
  // ═══════════════════════════════════════
  quotationType String @default("time_based") // "time_based" | "service_based"

  // Para cotizaciones con tiempo estimado (time_based)
  estimatedStartDate DateTime?
  estimatedEndDate   DateTime?
  estimatedDays      Int?

  // Para cotizaciones por servicio/trabajo (service_based)
  serviceDescription String? @db.Text

  // Validez
  quotationDate DateTime @default(now())
  validUntil    DateTime

  // Documentos
  templateId   String?
  pdfUrl       String? // PDF generado
  signedPdfUrl String? // PDF firmado

  // Firma digital
  signatureRequestId String? // ID en SignNow/DocuSign
  signatureStatus    String? // "pending", "signed", "declined", "expired"
  signatureProvider  String? // "signow", "docusign"
  signedAt           DateTime?
  signedBy           String?

  // Pago
  paymentStatus   String    @default("pending") // "pending", "paid", "failed"
  paymentIntentId String?
  paidAt          DateTime?

  // Metadata
  notes              String? @db.Text
  termsAndConditions String? @db.Text
  metadata           Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relaciones
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id])
  assignedUser User?        @relation("AssignedQuotations", fields: [assignedUserId], references: [id])
  template     Template?    @relation(fields: [templateId], references: [id])
  creator      User         @relation("CreatedQuotations", fields: [createdBy], references: [id])

  items          QuotationItem[]
  contract       QuotationContract?
  rentalContract RentalContract?

  @@unique([tenantId, code])
  @@index([tenantId, businessUnitId, status])
  @@index([clientId])
  @@index([signatureRequestId])
  @@index([createdAt])
  @@map("quotations")
}

model QuotationItem {
  id          String  @id @default(uuid())
  quotationId String
  assetId     String? // Para alquiler de maquinaria
  productId   String? // Para otros rubros
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Auto-cálculo de precios con override manual
  calculatedUnitPrice    Decimal? @db.Decimal(10, 2) // Precio calculado automáticamente desde el asset
  priceOverridden        Boolean  @default(false) // Flag: precio fue modificado manualmente
  operatorIncluded       Boolean  @default(false) // Si la cotización incluye operador
  operatorCost           Decimal? @db.Decimal(10, 2) // Costo del operador (puede ser override)
  calculatedOperatorCost Decimal? @db.Decimal(10, 2) // Costo del operador calculado automáticamente

  // ═══════════════════════════════════════
  // RENTAL: Configuración avanzada (v4.0)
  // ═══════════════════════════════════════

  // Específico de rental
  rentalDays      Int?
  rentalStartDate DateTime?
  rentalEndDate   DateTime?

  // Tipo de período de renta
  rentalPeriodType String? // "hourly" | "daily" | "weekly" | "monthly"

  // STANDBY: Horas mínimas garantizadas (para MACHINERY)
  standbyHours Decimal? @db.Decimal(5, 2) // Ej: 3.0 horas/día mínimas facturadas

  // Tipo de costo del operador
  operatorCostType String? // "PER_DAY" | "PER_HOUR"

  // Desglose detallado de costos (opcional)
  basePrice          Decimal? @db.Decimal(10, 2) // Precio base del asset solamente
  operatorCostAmount Decimal? @db.Decimal(10, 2) // Costo del operador separado
  maintenanceCost    Decimal? @db.Decimal(10, 2) // Costo de mantenimiento incluido
  discount           Decimal? @db.Decimal(10, 2) // Descuento aplicado al item
  discountReason     String? // Razón del descuento

  metadata  Json?
  sortOrder Int   @default(0)

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  asset     Asset?    @relation(fields: [assetId], references: [id])

  @@index([quotationId])
  @@map("quotation_items")
}

model QuotationContract {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  quotationId    String @unique
  code           String // CON-2026-001
  status         String // "active", "completed", "cancelled", "suspended"

  // Período
  startDate DateTime
  endDate   DateTime

  // Documentos
  templateId   String?
  pdfUrl       String
  signedPdfUrl String

  // Renovación
  autoRenew       Boolean @default(false)
  renewalNotified Boolean @default(false)

  // Montos (copiados de quotation)
  totalAmount Decimal @db.Decimal(12, 2)
  currency    String  @default("USD")

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  quotation    Quotation    @relation(fields: [quotationId], references: [id])
  template     Template?    @relation(fields: [templateId], references: [id])
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, businessUnitId, status])
  @@index([startDate, endDate])
  @@map("quotation_contracts")
}

// ============================================
// BRANDING Y PERSONALIZACIÓN
// ============================================

model BusinessUnitBranding {
  id             String @id @default(uuid())
  businessUnitId String @unique

  // Logo y Colores
  logoUrl        String?
  primaryColor   String  @default("#1E40AF") // Color principal (ej: azul)
  secondaryColor String  @default("#64748B") // Color secundario (ej: gris)
  fontFamily     String  @default("Inter") // Fuente del documento

  // Configuración de Header (JSON)
  // { showLogo: boolean, logoAlign: "left"|"center"|"right", showBusinessName: boolean, showTaxInfo: boolean, height: number }
  headerConfig Json @default("{\"showLogo\":true,\"logoAlign\":\"left\",\"showBusinessName\":true,\"showTaxInfo\":false,\"height\":80}")

  // Configuración de Footer (JSON)
  // { showContactInfo: boolean, showDisclaimer: boolean, disclaimerText?: string, height: number }
  footerConfig Json @default("{\"showContactInfo\":true,\"showDisclaimer\":false,\"height\":60}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@index([businessUnitId])
  @@map("business_unit_branding")
}

// Plantillas de Documentos Personalizadas
model DocumentTemplate {
  id             String @id @default(uuid())
  businessUnitId String
  tenantId       String // Multi-tenant isolation

  // Información básica
  name         String // Nombre de la plantilla (ej: "Cotización Premium", "Contrato Estándar")
  description  String?
  documentType String // quotation | contract | receipt | note | report
  isActive     Boolean @default(true)
  isDefault    Boolean @default(false) // Si es la plantilla por defecto para este tipo

  // Configuración de diseño (JSON)
  // { format: "A4" | "Letter", orientation: "portrait" | "landscape", margins: {...} }
  layoutConfig Json @default("{\"format\":\"A4\",\"orientation\":\"portrait\",\"margins\":{\"top\":20,\"right\":20,\"bottom\":20,\"left\":20}}")

  // Secciones del documento (JSON array)
  // [{ type: "header"|"content"|"footer"|"table"|"signature", config: {...}, order: number }]
  sections Json @default("[]")

  // Contenido HTML personalizado (con variables Handlebars)
  // Variables disponibles: {{businessUnitName}}, {{logoUrl}}, {{date}}, {{items}}, etc.
  htmlContent String? @db.Text

  // Estilos CSS personalizados
  customStyles String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relaciones
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, documentType, isDefault]) // Solo una plantilla por defecto por tipo
  @@index([tenantId, businessUnitId])
  @@index([documentType, isActive])
  @@map("document_templates")
}

// Plantillas de Emails
model EmailTemplate {
  id             String @id @default(uuid())
  businessUnitId String
  tenantId       String // Multi-tenant isolation

  // Información básica
  name        String // Nombre de la plantilla (ej: "Bienvenida Cliente", "Recordatorio Pago")
  description String?
  emailType   String // welcome | quotation_sent | contract_signed | payment_reminder | invoice | custom
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false)

  // Configuración del email
  subject      String // Puede contener variables: "Cotización {{code}} - {{clientName}}"
  fromName     String? // Nombre del remitente (si es null, usa el nombre de la BU)
  replyToEmail String? // Email de respuesta

  // Contenido del email
  // HTML con variables Handlebars: {{clientName}}, {{amount}}, {{dueDate}}, etc.
  htmlContent String  @db.Text
  textContent String? @db.Text // Versión texto plano (fallback)

  // Pre-header (preview text que aparece en clientes de email)
  preheader String?

  // Configuración de branding
  useBranding  Boolean @default(true) // Si usa los colores/logo de BusinessUnitBranding
  customColors Json? // Override de colores: { primary: "#...", secondary: "#..." }

  // Adjuntos por defecto (JSON array)
  // [{ type: "quotation_pdf" | "contract_pdf" | "custom", filename: "..." }]
  defaultAttachments Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relaciones
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, emailType, isDefault]) // Solo una plantilla por defecto por tipo
  @@index([tenantId, businessUnitId])
  @@index([emailType, isActive])
  @@map("email_templates")
}
