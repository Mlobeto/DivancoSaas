// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: TENANTS Y BUSINESS UNITS
// ============================================

model Tenant {
  id     String       @id @default(uuid())
  name   String
  slug   String       @unique
  status TenantStatus @default(ACTIVE)

  // SaaS Billing (subscription to the platform)
  plan         String  @default("free") // free, pro, enterprise
  billingEmail String?

  // Payment Provider Selection
  country                  String? // ISO 3166-1 alpha-2 (CO, MX, US, etc.)
  preferredPaymentProvider String? // stripe, wompi, mercadopago

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits BusinessUnit[]
  users         User[]
  subscriptions PlatformSubscription[]
  auditLogs     AuditLog[]
  eventQueue    EventQueue[]
  equipment     Equipment[]
  assets        Asset[]

  @@index([slug])
  @@index([country])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

model BusinessUnit {
  id          String  @id @default(uuid())
  tenantId    String
  name        String
  description String?
  slug        String

  // Configuración
  settings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                 Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enabledModules         BusinessUnitModule[]
  workflows              Workflow[]
  userBusinessUnits      UserBusinessUnit[]
  integrationCredentials IntegrationCredential[]
  integrations           BusinessUnitIntegration[]
  channelConfigs         BusinessUnitChannelConfig[]
  businessUnitIntents    BusinessUnitIntent[]
  userChannelIdentities  UserChannelIdentity[]
  eventQueue             EventQueue[]
  equipment              Equipment[]
  assets                 Asset[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("business_units")
}

// ============================================
// CORE: USUARIOS Y AUTENTICACIÓN
// ============================================

model User {
  id        String     @id @default(uuid())
  tenantId  String
  email     String
  password  String
  firstName String
  lastName  String
  avatar    String?
  status    UserStatus @default(ACTIVE)

  // Password Reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Sistema
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnits     UserBusinessUnit[]
  auditLogs         AuditLog[]
  channelIdentities UserChannelIdentity[]
  eventQueue        EventQueue[]
  assetUsages       AssetUsage[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([resetPasswordToken])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Relación many-to-many con roles por BU
model UserBusinessUnit {
  id             String @id @default(uuid())
  userId         String
  businessUnitId String
  roleId         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, businessUnitId])
  @@index([userId])
  @@index([businessUnitId])
  @@map("user_business_units")
}

// ============================================
// CORE: RBAC - ROLES Y PERMISOS
// ============================================

model Role {
  id          String  @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean @default(false) // true = no se puede eliminar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  permissions       RolePermission[]
  userBusinessUnits UserBusinessUnit[]

  @@map("roles")
}

model Permission {
  id       String          @id @default(uuid())
  resource String // "projects", "users", "settings"
  action   String // "create", "read", "update", "delete"
  scope    PermissionScope @default(BUSINESS_UNIT)

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

enum PermissionScope {
  TENANT // Acceso a nivel tenant
  BUSINESS_UNIT // Acceso a nivel business unit (default)
  OWN // Solo datos propios
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// CORE: MÓDULOS Y ACTIVACIÓN
// ============================================

model Module {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?
  version     String  @default("1.0.0")
  category    String? // "commerce", "projects", "livestock", "logistics"

  isActive Boolean @default(true)

  // Configuración por defecto
  defaultConfig Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnits BusinessUnitModule[]
  workflows     Workflow[]

  @@map("modules")
}

model BusinessUnitModule {
  id             String @id @default(uuid())
  businessUnitId String
  moduleId       String

  isEnabled Boolean @default(true)
  config    Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId])
  @@index([businessUnitId])
  @@map("business_unit_modules")
}

// ============================================
// CORE: WORKFLOWS CONFIGURABLES
// ============================================

model Workflow {
  id             String  @id @default(uuid())
  businessUnitId String
  moduleId       String
  name           String
  description    String?

  // Estados del workflow (JSON array)
  states Json // [{ id, name, color, order, isInitial, isFinal }]

  // Transiciones permitidas (JSON array)
  transitions Json // [{ from, to, label, requiredRole }]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id])

  @@unique([businessUnitId, moduleId, name])
  @@map("workflows")
}

// ============================================
// CORE: BILLING DEL SAAS (SUSCRIPCIONES)
// ============================================

model PlatformSubscription {
  id       String             @id @default(uuid())
  tenantId String
  plan     String // free, pro, enterprise
  status   SubscriptionStatus @default(ACTIVE)

  // Facturación
  amount       Float
  currency     String @default("USD")
  billingCycle String @default("monthly") // monthly, yearly

  // Fechas
  startDate       DateTime
  endDate         DateTime?
  nextBillingDate DateTime?
  cancelledAt     DateTime?

  // Proveedor de pago
  paymentProvider String? // stripe, mercadopago, etc
  externalId      String? // ID en el proveedor externo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("platform_subscriptions")
}

enum SubscriptionStatus {
  PENDING // Esperando confirmación de pago
  ACTIVE // Suscripción activa
  PAST_DUE // Pago vencido
  CANCELLED // Cancelada por el usuario
  EXPIRED // Expirada por falta de pago
}

// ============================================
// CORE: AUDITORÍA Y TRAZABILIDAD
// ============================================

model AuditLog {
  id       String  @id @default(uuid())
  tenantId String
  userId   String?

  entity   String // "user", "project", "invoice"
  entityId String?
  action   String // "create", "update", "delete"

  // Datos antes y después (opcional)
  oldData Json?
  newData Json?

  metadata  Json    @default("{}")
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// CORE: INTEGRACIONES EXTERNAS
// ============================================

// Credenciales de integraciones por BusinessUnit
// Cada BU puede tener sus propias configuraciones de proveedores externos
model IntegrationCredential {
  id             String          @id @default(uuid())
  businessUnitId String
  provider       IntegrationType

  // Credenciales encriptadas (JSON flexible según proveedor)
  credentials Json

  // Estado
  isActive      Boolean   @default(true)
  lastValidated DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, provider])
  @@index([businessUnitId])
  @@map("integration_credentials")
}

// Configuración de integraciones de terceros (facturación, envíos, etc.)
model BusinessUnitIntegration {
  id             String @id @default(uuid())
  businessUnitId String
  type           String // "invoice", "shipping", "sms", "email"
  provider       String // "taxxa", "divanco", "fedex", "manual", etc.

  // Credenciales y configuración
  credentials Json // { apiKey, apiSecret, accountNumber, etc. }
  config      Json // { environment, defaultOrigin, metadata, etc. }

  // Estado
  isActive      Boolean   @default(true)
  lastValidated DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, type, provider])
  @@index([businessUnitId])
  @@index([type])
  @@map("business_unit_integrations")
}

enum IntegrationType {
  // Comunicaciones
  SENDGRID // Email transaccional y marketing
  AZURE_COMMUNICATION_SERVICES // Email + SMS + WhatsApp de Azure
  META_WHATSAPP // WhatsApp Business Cloud API
  TWILIO_SMS // SMS transaccional

  // Pagos
  STRIPE // Pagos internacionales
  MERCADOPAGO // Pagos LATAM
  WOMPI // Pagos Colombia

  // Storage
  AZURE_BLOB_STORAGE // Azure Blob Storage con Sharp
  AWS_S3 // Almacenamiento de archivos (legacy)
  CLOUDINARY // Imágenes y multimedia (legacy)

  // Facturación
  SIIGO // Facturación electrónica Colombia
  FACTURAMA // Facturación electrónica México

  // Otros
  GOOGLE_MAPS // Mapas y geolocalización
  SENDGRID_ANALYTICS // Analytics de emails
}

// ============================================
// CANALES E INTENCIONES
// ============================================

// Configuración de canales por Business Unit
model BusinessUnitChannelConfig {
  id             String      @id @default(uuid())
  businessUnitId String
  channel        ChannelType

  // Estado
  enabled Boolean @default(true)

  // Intenciones permitidas desde este canal
  // ["*"] = todas, o lista específica como ["UPLOAD_IMAGE", "PROJECT_UPDATE"]
  allowedIntents Json @default("[]")

  // Configuración específica del canal (opcional)
  config Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([businessUnitId, channel])
  @@index([businessUnitId])
  @@map("business_unit_channel_configs")
}

enum ChannelType {
  WHATSAPP
  WEB
  MOBILE
  API
}

// Catálogo de intenciones disponibles en la plataforma
model IntentDefinition {
  id          String  @id @default(uuid())
  name        String  @unique // "UPLOAD_IMAGE", "PROJECT_UPDATE", etc.
  displayName String // "Subir Imagen", "Actualizar Proyecto"
  description String?
  category    String? // "storage", "projects", "communications"

  // Módulo y acción por defecto
  defaultModule String // "storage", "projects"
  defaultAction String // "uploadFile", "updateStatus"

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnitIntents BusinessUnitIntent[]

  @@map("intent_definitions")
}

// Configuración de intenciones por Business Unit
// Permite personalizar qué hace cada intención en cada BU
model BusinessUnitIntent {
  id             String @id @default(uuid())
  businessUnitId String
  intentId       String

  // Personalización de la acción (sobrescribe defaults)
  module             String? // Si null, usa defaultModule
  action             String? // Si null, usa defaultAction
  requiredPermission String? // "projects.update", "files.upload"

  // Configuración específica de la intención
  config Json @default("{}")

  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessUnit     BusinessUnit     @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  intentDefinition IntentDefinition @relation(fields: [intentId], references: [id])

  @@unique([businessUnitId, intentId])
  @@index([businessUnitId])
  @@map("business_unit_intents")
}

// Identidad de usuario en canales externos (WhatsApp, etc.)
model UserChannelIdentity {
  id             String      @id @default(uuid())
  userId         String
  businessUnitId String
  channel        ChannelType

  // Identificador en el canal externo
  externalId String // Número de teléfono para WhatsApp, deviceId para mobile, etc.

  // Verificación
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  // Metadata adicional
  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([userId, businessUnitId, channel, externalId])
  @@index([userId])
  @@index([externalId, channel])
  @@map("user_channel_identities")
}

// Cola de eventos para procesamiento asíncrono y offline
model EventQueue {
  id             String      @id @default(uuid())
  tenantId       String
  businessUnitId String
  userId         String
  channel        ChannelType

  // Intención y datos
  intent  String
  payload Json

  // Estado del procesamiento
  status EventStatus @default(PENDING)

  // Metadata
  metadata Json @default("{}")

  // Reintentos
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?
  processedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([tenantId])
  @@index([userId])
  @@map("event_queue")
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// MÓDULOS: EQUIPOS Y MAQUINARIA
// ============================================

model Equipment {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  // Identificación
  code        String // Código único interno (EXC-CAT-320, GRU-LIE-110)
  name        String
  category    String // "Maquinaria pesada", "Acceso y soporte", etc.
  description String?

  // Especificaciones técnicas
  specifications Json @default("{}")

  // Costos de alquiler
  dailyRate   Decimal @db.Decimal(10, 2)
  weeklyRate  Decimal @db.Decimal(10, 2)
  monthlyRate Decimal @db.Decimal(10, 2)

  // Estado
  status    EquipmentStatus    @default(AVAILABLE)
  condition EquipmentCondition @default(GOOD)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([businessUnitId])
  @@index([status])
  @@map("equipment")
}

enum EquipmentStatus {
  AVAILABLE // Disponible para alquiler
  RENTED // Actualmente alquilado
  MAINTENANCE // En mantenimiento
  OUT_OF_SERVICE // Fuera de servicio
  RESERVED // Reservado
}

enum EquipmentCondition {
  EXCELLENT // Excelente
  GOOD // Buena
  FAIR // Regular
  POOR // Mala
}

// ============================================
// ASSETS MODULE - Rental Equipment Management
// ============================================

model Asset {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String

  name            String
  assetType       String // String libre: machine, implement, vehicle, etc
  acquisitionCost Decimal?
  origin          String?

  requiresOperator Boolean @default(false)
  requiresTracking Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessUnit       BusinessUnit        @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  state              AssetState?
  maintenanceRecords MaintenanceRecord[]
  usages             AssetUsage[]
  events             AssetEvent[]
  attachments        AssetAttachment[]

  @@index([tenantId, businessUnitId])
  @@index([assetType])
  @@map("assets")
}

model AssetState {
  id           String @id @default(uuid())
  assetId      String @unique
  workflowId   String
  currentState String // String libre, workflow-driven

  updatedAt DateTime @updatedAt

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@map("asset_states")
}

model AssetEvent {
  id             String @id @default(uuid())
  tenantId       String
  businessUnitId String
  assetId        String

  eventType String // String libre: created, rented, returned, maintenance_started, etc
  payload   Json
  source    String // String libre: web, mobile, whatsapp, system

  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id])

  @@index([tenantId, businessUnitId, assetId])
  @@index([assetId, createdAt])
  @@index([eventType])
  @@map("asset_events")
}

model MaintenanceRecord {
  id          String    @id @default(uuid())
  assetId     String
  description String?
  startedAt   DateTime
  endedAt     DateTime?

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([startedAt])
  @@map("maintenance_records")
}

model AssetUsage {
  id               String   @id @default(uuid())
  assetId          String
  date             DateTime
  hoursUsed        Decimal
  standbyHours     Decimal?
  reportedByUserId String?
  source           String // String libre: APP, WHATSAPP, API, SYSTEM
  notes            String?
  createdAt        DateTime @default(now())

  asset      Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  reportedBy User? @relation(fields: [reportedByUserId], references: [id], onDelete: SetNull)

  @@index([assetId, date])
  @@index([reportedByUserId])
  @@map("asset_usages")
}

model AssetAttachment {
  id        String   @id @default(uuid())
  assetId   String
  type      String // String libre: PHOTO, PDF, VIDEO, etc
  url       String
  source    String // String libre: WHATSAPP, APP, SYSTEM
  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([type])
  @@map("asset_attachments")
}
